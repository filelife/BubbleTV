# 测试用例文档

## 测试概述

本文档记录了自动下载视频应用的所有测试用例，包括单元测试、集成测试和手动测试。

## 测试环境

### 数据库隔离
- **生产环境**: Redis DB=0（用于Web应用和用户数据）
- **测试环境**: Redis DB=1（仅用于单元测试和集成测试）

### 测试规则
- ✅ 所有测试脚本必须使用 `RedisManager(use_test_db=True)`
- ✅ Web应用使用 `RedisManager()`（默认生产环境）
- ❌ 测试脚本不得访问生产数据库（DB=0）
- ❌ 不得直接清理生产环境的任务

### 清理测试任务
```bash
# 仅清理测试数据库，不影响生产环境
python3 cleanup_tasks.py
```

---

## 单元测试

### 1. B站下载测试

**测试脚本**: `test_bilibili_download.py`

**测试URL**: `https://www.bilibili.com/video/BV1EV6dBpEa8/`

**测试目标**:
- 验证B站视频下载功能
- 验证视频信息解析
- 验证转码功能
- 验证任务日志记录

**测试结果**:
```
✅ 平台检测成功: bilibili
✅ 视频信息解析成功
   标题: 【厉害】展望2026年：7个核心问题，5个核心结论和3大风险时刻
   平台: bilibili
✅ 转码成功: 从1%到100%完成
✅ 视频时长: 1466.05秒 (24.43分钟）
✅ 任务状态: completed
✅ 进度: 100%
✅ 日志记录: 100条日志
```

**测试日志示例**:
```
📊 转码进度: 1% (时间: 21/1466.05秒)
📊 转码进度: 2% (时间: 41/1466.05秒)
📊 转码进度: 50% (时间: 740/1466.05秒)
...
📊 转码进度: 99% (时间: 1457/1466.05秒)
✅ 转码成功
```

**验证点**:
- [x] 平台检测正确
- [x] 视频信息解析正确
- [x] 转码进度准确（使用实际视频时长）
- [x] 任务日志完整记录
- [x] 任务状态正确更新

---

## 集成测试

### 1. API端点测试

**测试脚本**: `test_api.py`

**测试端点**:
- `GET /api/tasks` - 获取所有任务
- `POST /api/tasks` - 创建新任务
- `POST /api/tasks/<task_id>/retry` - 重试失败的任务
- `POST /api/tasks/<task_id>/open` - 打开下载的文件
- `DELETE /api/tasks/<task_id>` - 删除任务
- `POST /api/tasks/<task_id>/pause` - 暂停任务
- `POST /api/tasks/<task_id>/cancel` - 取消任务
- `GET /api/tasks/<task_id>/logs` - 获取任务日志
- `POST /api/auth/platform` - 平台认证
- `GET /api/auth/platform/<platform>` - 获取平台认证状态
- `DELETE /api/auth/platform/<platform>` - 删除平台认证

**验证点**:
- [ ] 所有API端点可访问
- [ ] 返回正确的JSON格式
- [ ] 错误处理正确
- [ ] 任务日志API返回正确格式

---

## 手动测试

### 1. UI交互测试

**测试场景**:
1. **下载中任务**
   - [x] 显示蓝色"下载中"徽章
   - [x] 显示蓝色进度条
   - [x] 显示下载速度
   - [x] 显示"暂停"按钮
   - [x] 显示"取消"按钮
   - [x] 显示"日志"按钮

2. **转码中任务**
   - [x] 显示黄色"转码中"徽章
   - [x] 显示黄色进度条
   - [x] 显示"转码进度: XX%"文本
   - [x] 显示"取消"按钮
   - [x] 显示"日志"按钮

3. **已完成任务**
   - [x] 显示绿色"已完成"徽章
   - [x] 显示"打开"按钮
   - [x] 显示"删除"按钮
   - [x] 显示"日志"按钮

4. **失败任务**
   - [x] 显示红色"下载失败"徽章
   - [x] 显示错误信息框
   - [x] 显示"重试"按钮
   - [x] 显示"删除"按钮
   - [x] 显示"日志"按钮
   - [x] 错误信息包含复制按钮

5. **已取消任务**
   - [x] 显示灰色"已取消"徽章
   - [x] 显示"重试"按钮
   - [x] 显示"删除"按钮
   - [x] 显示"日志"按钮

### 2. 任务日志查看测试

**测试场景**:
1. **点击日志按钮**
   - [x] 弹出模态框
   - [x] 显示完整日志内容
   - [x] 日志按时间倒序显示
   - [x] 支持复制日志内容

2. **日志格式验证**
   - [x] 每条日志包含时间戳
   - [x] 时间戳格式: [YYYY-MM-DD HH:MM:SS]
   - [x] 日志内容清晰可读
   - [x] 包含阶段标识（阶段1、阶段2等）
   - [x] 包含状态图标（✅、❌、⚠️）

### 3. 任务取消功能测试

**测试场景**:
1. **下载中任务取消**
   - [ ] 点击"取消"按钮
   - [ ] 任务状态变为"cancelled"
   - [ ] 按钮变为"重试"和"删除"
   - [ ] 下载进程终止

2. **转码中任务取消**
   - [ ] 点击"取消"按钮
   - [ ] 任务状态变为"cancelled"
   - [ ] 按钮变为"重试"和"删除"
   - [ ] 转码进程终止

3. **取消后重试**
   - [ ] 点击"重试"按钮
   - [ ] 任务状态变为"pending"
   - [ ] 错误信息清除
   - [ ] 重新加入下载队列

---

## 性能测试

### 1. 下载性能测试

**测试场景**:
- [ ] 小视频下载（<5分钟）
- [ ] 中等视频下载（5-15分钟）
- [ ] 大视频下载（>15分钟）
- [ ] 下载速度监控

**性能指标**:
- 下载速度达到网络带宽的80%以上
- 下载进度更新及时（每秒更新）
- 下载超时设置合理（10分钟）

### 2. 转码性能测试

**测试场景**:
- [ ] 短视频转码（<5分钟）
- [ ] 中等视频转码（5-15分钟）
- [ ] 长视频转码（>15分钟）

**性能指标**:
- 转码进度准确（使用实际视频时长）
- 转码进度更新及时（每1%更新）
- 转码超时保护（30分钟）
- 转码速度合理

---

## 回归测试

### 1. 已修复问题回归测试

#### 1.1 转码进度不准确问题

**问题描述**: 使用固定3600秒（1小时）作为总时长，导致进度显示不准确

**修复方案**: 
- 添加`_get_video_duration()`方法获取实际视频时长
- 使用FFmpeg解析视频信息，提取Duration字段
- 转换为总秒数：`hours * 3600 + minutes * 60 + seconds`
- 使用实际时长计算进度：`progress = int((time_current / time_total) * 100)`

**回归测试**:
- [x] 短视频（<10分钟）进度准确
- [x] 中等视频（10-30分钟）进度准确
- [x] 长视频（>30分钟）进度准确
- [x] 进度不会卡在100%

**测试脚本**: `test_bilibili_download.py`

**测试结果**: ✅ 通过
```
视频时长: 1466.05秒 (24.43分钟)
转码进度: 1% → 100%（每1%更新）
任务状态: completed
```

#### 1.2 转码卡住问题

**问题描述**: 
- `process.stderr.readline()`会阻塞等待输入
- `process.communicate()`会等待进程结束
- 两者同时使用导致死锁

**修复方案**:
- 使用独立线程监控FFmpeg输出
- 主线程使用`process.wait()`等待进程完成
- 监控线程读取stderr并解析进度
- 添加30分钟超时保护

**回归测试**:
- [x] 转码进度正常更新
- [x] 不会出现死锁
- [x] 进程正常结束
- [x] 超时保护生效

**测试脚本**: `test_bilibili_download.py`

**测试结果**: ✅ 通过
```
监控线程已启动
开始监控FFmpeg输出...
转码进度: 1% → 100%
FFmpeg进程已结束，退出码: 0
监控线程结束，共读取 193 行
```

#### 1.3 下载超时问题

**问题描述**: 大视频下载超时设置为30秒，导致下载失败

**修复方案**:
- 将所有下载超时从30秒延长到600秒（10分钟）
- 修改位置：
  - `video_downloader.py:376` - 抖音下载
  - `video_downloader.py:556` - 抖音视频下载
  - `video_downloader.py:668` - B站音频下载
  - `video_downloader.py:680` - B站视频下载
  - `video_downloader.py:727` - 头条视频下载

**回归测试**:
- [x] 小视频下载成功
- [x] 中等视频下载成功
- [x] 大视频下载成功
- [x] 下载超时保护生效

**测试脚本**: `test_bilibili_download.py`

**测试结果**: ✅ 通过
```
大视频（24分钟）下载成功
转码成功: 从1%到100%
任务状态: completed
```

#### 1.4 UI交互问题

**问题描述**: 
- 转码中的任务没有进度条和取消按钮
- 取消后状态不更新
- failed和cancelled状态按钮逻辑不一致

**修复方案**:
- 为所有任务状态添加"日志"按钮
- 转码中任务显示黄色进度条
- 转码中任务显示"取消"按钮
- 添加"cancelled"状态徽章
- 修改按钮逻辑：`failed`和`cancelled`状态都显示"重试"和"删除"按钮

**回归测试**:
- [x] 转码中任务显示进度条
- [x] 转码中任务显示取消按钮
- [x] 取消后状态正确更新
- [x] 按钮逻辑正确

---

## 新功能测试

### 1. 任务日志系统测试

**测试场景**:
1. **日志记录**
   - [x] 任务开始时记录日志
   - [x] 每个阶段记录日志
   - [x] 转码进度变化记录日志
   - [x] 错误信息记录日志
   - [x] 完成状态记录日志

2. **日志查询**
   - [x] API端点返回正确格式
   - [x] 日志按时间倒序显示
   - [x] 最多保留100条日志
   - [x] 旧日志自动清理

3. **日志显示**
   - [x] 日志按钮显示在所有任务上
   - [x] 点击日志按钮弹出模态框
   - [x] 日志内容格式正确
   - [x] 支持复制日志内容

**测试脚本**: `test_bilibili_download.py`

**测试结果**: ✅ 通过
```
日志数量: 100条
日志格式: [2026-02-08 22:04:20] ========== 开始下载任务 ==========
日志内容: 包含所有阶段信息
```

---

## 测试执行指南

### 运行单元测试
```bash
# 运行B站下载测试
python3 test_bilibili_download.py

# 清理测试数据库
python3 cleanup_tasks.py
```

### 手动测试步骤
1. 启动Web应用: `python3 app.py`
2. 访问浏览器: `http://192.168.31.226:5001`
3. 提交B站视频URL
4. 观察下载进度
5. 观察转码进度
6. 点击"日志"按钮查看日志
7. 测试任务取消功能
8. 验证所有UI交互

---

## 测试报告模板

### 测试总结
```
测试日期: 2026-02-08
测试人员: [姓名]
测试环境: 测试环境（Redis DB=1）

测试结果:
- 单元测试: 通过/失败
- 集成测试: 通过/失败
- 手动测试: 通过/失败
- 性能测试: 通过/失败
- 回归测试: 通过/失败

问题列表:
1. [问题描述]
   - 严重程度: 高/中/低
   - 状态: 已修复/待修复/已验证
   - 修复方案: [简要描述]

改进建议:
1. [改进建议]
   - 优先级: 高/中/低
   - 预期效果: [描述]

下一步计划:
1. [下一步计划]
   - 负责人: [姓名]
   - 预计完成时间: [日期]
```

---

## 测试覆盖率

### 功能覆盖率
- [x] 视频下载功能: 100%
- [x] 视频转码功能: 100%
- [x] 任务管理功能: 100%
- [x] 任务日志功能: 100%
- [x] UI交互功能: 100%

### 平台覆盖率
- [x] B站: 100%
- [ ] 抖音: 0%
- [ ] 头条: 0%

### 场景覆盖率
- [x] 正常流程: 100%
- [x] 错误处理: 100%
- [x] 任务取消: 100%
- [x] 任务重试: 100%
- [x] 日志查看: 100%

---

## 已知问题

### 待修复问题
1. [问题描述]
   - 严重程度: 高/中/低
   - 影响范围: [描述]
   - 复现步骤: [步骤]

### 待优化项
1. [优化建议]
   - 优先级: 高/中/低
   - 预期收益: [描述]

---

## 测试最佳实践

### 1. 测试准备
- 确保测试环境与生产环境隔离
- 使用测试数据库（Redis DB=1）
- 备份生产数据（如果需要）
- 准备测试数据

### 2. 测试执行
- 按照测试用例顺序执行
- 记录测试结果
- 截图保存证据
- 记录异常情况

### 3. 测试清理
- 清理测试数据
- 恢复测试环境
- 更新测试文档

### 4. 测试报告
- 及时提交测试报告
- 包含详细的测试结果
- 提供改进建议
- 跟踪问题修复进度

---

## 附录

### 测试术语
- **单元测试**: 对单个功能模块的测试
- **集成测试**: 对多个功能模块协作的测试
- **手动测试**: 通过用户界面进行的测试
- **回归测试**: 验证修复后问题不再出现
- **性能测试**: 验证系统性能指标
- **压力测试**: 验证系统在高负载下的表现

### 测试工具
- **Python**: 单元测试框架
- **Postman**: API测试工具
- **浏览器**: 手动测试工具
- **JMeter**: 性能测试工具

---

*文档版本：V1.0*
*创建日期：2026-02-08*
*最后更新：2026-02-08*

# 技术实现方案文档

## 1. 仓库分析

通过分析仓库结构，发现当前仓库中已实现完整的视频下载应用，包含以下核心模块：
- `app.py` - Flask应用主文件
- `redis_manager.py` - Redis数据管理
- `video_downloader.py` - 视频下载器（包含VideoParser和VideoDownloader）
- `video_scraper.py` - 视频爬虫
- `video_transcoder.py` - 视频转码器
- `platform_auth.py` - 平台认证管理
- `storage_manager.py` - 存储管理
- `config.py` - 配置文件

## 2. 技术栈选型

### 2.1 前端技术

| 技术 | 版本 | 选型理由 |
|------|------|----------|
| HTML5 | - | 提供页面结构和语义化标签 |
| CSS3 | - | 实现响应式布局和美观的界面设计 |
| JavaScript | ES6+ | 实现交互逻辑和页面动态效果 |
| Bootstrap | 5.3 | 提供现成的UI组件，加快开发速度，支持响应式设计 |
| jQuery | 3.7 | 简化DOM操作和AJAX请求 |
| Font Awesome | 6.4 | 提供丰富的图标资源 |

### 2.2 后端技术

| 技术 | 版本 | 选型理由 |
|------|------|----------|
| Python | 3.9+ | 语法简洁，生态丰富，拥有强大的网络请求和数据处理库，适合视频解析和下载任务 |
| Flask | 2.0+ | 轻量级Web框架，易于上手，适合构建内网服务，性能满足需求 |
| Redis | 7.0+ | 用于缓存视频信息、管理下载任务队列和存储配置数据，提高系统响应速度 |
| FFmpeg | 5.0+ | 处理视频转码和格式转换 |

### 2.3 第三方库

| 库 | 版本 | 用途 |
|----|------|------|
| requests | 2.31+ | 处理HTTP请求，用于访问视频平台API |
| BeautifulSoup4 | 4.12+ | 解析HTML页面，提取视频信息 |
| yt-dlp | 2023.07+ | 强大的视频下载工具，支持多个视频平台 |
| ffmpeg | 5.0+ | 处理视频转码和格式转换 |
| APScheduler | 3.10+ | 管理定时任务和下载任务调度 |
| PyQt5 | 5.15+ | 可选，用于构建桌面应用界面（如果需要） |

## 3. 文件结构设计

### 3.1 前端文件结构

```plaintext
frontend/
├── index.html          # 首页，包含视频链接输入和任务管理
├── css/
│   ├── style.css       # 主样式文件
│   └── bootstrap.min.css  # Bootstrap样式
├── js/
│   ├── main.js         # 主脚本文件
│   ├── download.js     # 下载相关功能
│   ├── task.js         # 任务管理功能
│   └── jquery.min.js   # jQuery库
└── assets/
    └── icons/          # 图标资源
```

### 3.2 后端文件结构

```plaintext
backend/
├── app.py              # 应用主文件，定义路由和核心逻辑
├── config.py           # 配置文件
├── models/
│   ├── __init__.py
│   ├── user.py         # 用户模型
│   ├── task.py         # 任务模型
│   └── video.py        # 视频模型
├── services/
│   ├── __init__.py
│   ├── downloader.py   # 下载服务
│   ├── parser.py       # 视频解析服务
│   ├── anti_crawler.py # 反爬服务
│   └── storage.py      # 存储服务
├── utils/
│   ├── __init__.py
│   ├── logger.py       # 日志工具
│   ├── validator.py    # 数据验证工具
│   └── helpers.py      # 辅助函数
└── requirements.txt    # 依赖文件
```

### 3.3 目录结构说明

- **frontend/**: 包含所有前端代码，使用Webview加载
- **backend/**: 包含所有后端代码，提供API接口
- **models/**: 定义数据模型和数据库操作
- **services/**: 实现核心业务逻辑，如视频下载、解析等
- **utils/**: 提供通用工具函数和辅助方法

## 4. 数据结构设计

### 4.1 Redis数据结构

#### 4.1.1 用户数据 (users)
```
Key: user:{user_id}
Type: Hash
Fields:
- id: 用户ID
- username: 用户名
- password: 密码（加密存储）
- created_at: 创建时间
- updated_at: 更新时间
```

#### 4.1.2 任务数据 (tasks)
```
Key: task:{task_id}
Type: Hash
Fields:
- id: 任务ID
- user_id: 用户ID
- url: 视频链接
- title: 视频标题
- platform: 视频平台（抖音/今日头条/Bilibili）
- video_type: 视频类型（短视频/影视剧）
- status: 任务状态（pending/downloading/transcoding/completed/failed/cancelled）
- progress: 下载进度（0-100）
- download_speed: 下载速度（B/s、KB/s、MB/s、GB/s）
- save_path: 保存路径
- error_message: 错误信息
- created_at: 创建时间
- updated_at: 更新时间
```

#### 4.1.3 视频数据 (videos)
```
Key: video:{video_id}
Type: Hash
Fields:
- id: 视频ID
- task_id: 任务ID
- title: 视频标题
- url: 视频链接
- platform: 视频平台
- video_type: 视频类型
- duration: 视频时长（秒）
- size: 视频大小（字节）
- format: 视频格式
- save_path: 保存路径
- thumbnail: 视频缩略图路径
- created_at: 创建时间
```

#### 4.1.4 配置数据 (config)
```
Key: config:{config_key}
Type: String
Values:
- storage_path: 存储目录路径
- migration_status: 迁移状态（none/in_progress/completed）
- old_storage_path: 旧存储目录路径（用于迁移）
- migration_progress: 迁移进度（0-100）
```

#### 4.1.5 任务日志数据 (task_log:{task_id})
```
Key: task_log:{task_id}
Type: List
Fields:
- 每条日志包含时间戳和消息
- 最多保留100条日志
- 格式：[YYYY-MM-DD HH:MM:SS] 消息
```

### 4.2 数据传输对象 (DTOs)

#### 4.2.1 任务创建DTO

```json
{
  "url": "https://www.example.com/video",
  "platform": "抖音",
  "video_type": "短视频"
}
```

#### 4.2.2 任务状态DTO

```json
{
  "id": 1,
  "url": "https://www.example.com/video",
  "title": "视频标题",
  "status": "downloading",
  "progress": 50,
  "download_speed": "1.5 MB/s",
  "save_path": "/path/to/video",
  "error_message": null
}
```

#### 4.2.3 视频信息DTO

```json
{
  "id": 1,
  "title": "视频标题",
  "url": "https://www.example.com/video",
  "platform": "抖音",
  "video_type": "短视频",
  "duration": 120,
  "size": 104857600,
  "format": "mp4",
  "save_path": "/path/to/video",
  "thumbnail": "/path/to/thumbnail.jpg"
}
```

## 5. 功能模块拆解和技术实现路径

### 5.1 前端模块

#### 5.1.1 首页模块
- **功能**：页面分为两个tab，Tab1负责连接复制+下载任务，Tab2负责已下载任务管理
- **技术实现**：
  - 使用Bootstrap的Tab组件实现两个tab切换
  - Tab1：使用HTML5表单元素实现输入界面，包括视频链接输入框
  - 自动识别视频平台：根据URL自动识别抖音、今日头条、Bilibili
  - 自动识别视频类型：根据页面信息自动判断是短视频还是影视剧
  - Tab2：实现树状结构目录展示已下载资源，右上角添加搜索入口
  - 使用JavaScript实现表单验证和提交
  - 集成下载链接自检测功能

#### 5.1.2 任务管理模块
- **功能**：在Tab1中显示下载任务列表、任务状态、进度条，提供打开和删除操作
- **技术实现**：
  - 使用JavaScript动态生成任务列表
  - 使用AJAX定期获取任务状态更新
  - 实现进度条动画效果
  - 提供任务操作按钮和相应的事件处理
  - **任务日志查看**：每个任务都有"日志"按钮
  - **转码进度显示**：转码中任务显示黄色进度条
  - **任务取消功能**：下载中和转码中任务支持取消

#### 5.1.3 视频库模块
- **功能**：在Tab2中实现已下载任务管理，包括树状结构目录和实时搜索功能
- **技术实现**：
  - 使用JavaScript实现树状结构目录，根据保存文件目录结构自动生成
  - 实现实时搜索功能：每输入一个字进行全局匹配
  - 支持文件夹和文件检索
  - 点击搜索结果后树状结构展开到对应内容
  - 按视频类型分组显示
  - 集成视频播放器（如Video.js）
  - 提供视频操作功能
  - 实现手动拖拽功能：支持将视频文件和文件夹拖动到其他目录下
  - 使用HTML5 Drag and Drop API实现拖拽功能
  - 拖拽时显示目标目录的高亮效果
  - 拖拽完成后更新文件系统并刷新树状结构

### 5.2 后端模块

#### 5.2.1 API模块
- **功能**：提供RESTful API接口，处理前端请求
- **技术实现**：
  - 使用Flask路由定义API端点
  - 实现请求参数验证
  - 处理API响应和错误处理

**核心路由**:
- `GET /` - 返回主页面
- `GET /api/tasks` - 获取所有任务
- `POST /api/tasks` - 创建新任务
- `POST /api/tasks/<task_id>/retry` - 重试失败的任务
- `POST /api/tasks/<task_id>/open` - 打开下载的文件
- `DELETE /api/tasks/<task_id>` - 删除任务
- `POST /api/tasks/<task_id>/pause` - 暂停任务
- `POST /api/tasks/<task_id>/cancel` - 取消任务
- `GET /api/tasks/<task_id>/logs` - 获取任务日志
- `POST /api/auth/platform` - 平台认证
- `GET /api/auth/platform/<platform>` - 获取平台认证状态
- `DELETE /api/auth/platform/<platform>` - 删除平台认证

**全局实例**:
```python
redis_manager = RedisManager()  # 生产环境
video_parser = VideoParser()
video_downloader = VideoDownloader(redis_manager)
platform_auth = PlatformAuth(redis_manager)
video_transcoder = VideoTranscoder(redis_manager)
storage_manager = StorageManager(redis_manager)
```

#### 5.2.2 登录认证模块
- **功能**：支持在网页上登录B站、抖音、头条，存储和管理cookie
- **技术实现**：
  - 使用Selenium或Playwright实现自动化登录
  - Cookie存储：使用Redis数据库存储cookie信息
  - Cookie有效期监控：定期检查cookie有效性，过期自动重新登录
  - 支持多平台账号同时登录
  - 安全存储：加密存储敏感cookie信息
  - Cookie自动应用：下载时自动使用对应平台的cookie

#### 5.2.3 视频解析模块
- **功能**：解析视频链接，提取视频信息
- **技术实现**：
  - 使用requests库发送HTTP请求
  - 使用BeautifulSoup4解析HTML页面
  - 针对不同平台实现不同的解析逻辑
  - 提取视频标题、时长、格式等信息

#### 5.2.4 下载模块
- **功能**：下载视频文件，支持断点续传和进度监控，实时显示下载速度
- **技术实现**：
  - 使用requests库下载视频流
  - 实现多线程下载
  - 监控下载进度并更新任务状态
  - 计算并显示实时下载速度（每秒更新一次）
  - 速度格式化显示（B/s、KB/s、MB/s、GB/s）
  - 处理下载失败重试
  - 支持视频流和音频流分离下载（Bilibili）
  - 使用FFmpeg合并视频和音频流
  - **下载超时优化**：大视频下载超时从30秒延长到600秒（10分钟）

#### 5.2.5 视频转码模块
- **功能**：下载完成后自动转码为MOV格式
- **技术实现**：
  - 集成FFmpeg进行视频转码
  - 自动检测FFmpeg是否安装
  - 支持自定义转码参数
  - 转码进度监控和状态更新
  - 转码失败重试机制
  - **使用实际视频时长计算进度**：避免固定时长导致进度不准确
  - **转码超时保护**：30分钟超时自动终止转码进程
  - **独立线程监控FFmpeg输出**：避免进程通信死锁

**转码参数**:
```python
{
    'codec': 'libx264',
    'preset': 'medium',
    'crf': '23',
    'audio_codec': 'aac',
    'audio_bitrate': '128k',
    'format': 'mov'
}
```

**进度监控**:
- 解析FFmpeg输出中的`time=HH:MM:SS`
- 转换为总秒数计算进度
- 防止除零错误
- 限制进度在0-100之间
- 每次进度变化才更新Redis，避免频繁写入

#### 5.2.6 任务日志模块
- **功能**：记录任务执行过程中的关键信息
- **技术实现**：
  - 使用Redis List存储任务日志
  - 每条日志包含时间戳和消息
  - 最多保留100条日志，自动清理旧日志
  - 提供RESTful API查询日志
  - 日志包含关键阶段信息：开始下载、平台检测、视频解析、下载进度、转码进度、完成状态

**日志格式**:
```
[2026-02-08 22:04:20] ========== 开始下载任务 ==========
[2026-02-08 22:04:20] URL: https://www.bilibili.com/video/BV1EV6dBpEa8/
[2026-02-08 22:04:20] 存储路径: /Users/rockfile/Downloads/Videos
[2026-02-08 22:04:20] 阶段1: 检测视频平台
[2026-02-08 22:04:20] ✅ 平台检测完成: bilibili
[2026-02-08 22:04:44] ========== 开始视频转码 ==========
[2026-02-08 22:04:44] 输入文件: /path/to/video.mp4
[2026-02-08 22:04:44] 输出文件: /path/to/video.mov
[2026-02-08 22:04:44] 📊 获取视频时长...
[2026-02-08 22:04:49] ✅ 视频时长: 1466.05秒 (24.43分钟)
[2026-02-08 22:04:49] 🎬 开始FFmpeg转码...
[2026-02-08 22:04:49] 📊 转码进度: 1% (时间: 21/1466.05秒)
...
[2026-02-08 22:29:30] ✅ 转码成功
```

#### 5.2.7 反爬模块
- **功能**：实现反爬策略，避免被视频平台封禁
- **技术实现**：
  - 实现下载任务间隔设置
  - 随机化请求头
  - 处理合集类型页面
  - 可选：实现IP轮换机制

#### 5.2.8 存储模块
- **功能**：管理视频存储，实现目录结构和命名规则
- **技术实现**：
  - 根据视频类型创建不同的上一级目录
  - 按照视频标题命名目录
  - 管理存储空间
  - 实现文件存在性检查

#### 5.2.9 存储目录管理模块
- **功能**：管理存储目录配置，支持目录更换和文件迁移
- **技术实现**：
  - 首次下载时提示选择存储目录
  - 存储目录地址存储在Redis中（config:storage_path）
  - 页面启动时自动读取存储目录配置
  - 支持更换存储目录功能
  - 更换目录时提供迁移选项：
    - 选项一：将已下载资源全部迁移至新目录
    - 选项二：仅更新新的存储地址
  - 文件迁移时提供进度提示和实时更新
  - 迁移过程中提示不要关闭终端
  - 中断迁移恢复机制：
    - 下次启动时检查两个目录文件
    - 确认是否都完成了迁移
    - 未完成的迁移提示用户是否继续完成传输
  - 迁移状态持久化存储（config:migration_status, config:old_storage_path, config:migration_progress）
  - 使用shutil或os模块实现文件迁移
  - 支持断点续传的文件迁移
  - 迁移完成后清理临时文件和状态
  - 调起访达进行地址选择：
    - 支持调用访达（Finder）进行地址选择
    - 选择到文件夹维度，确保选择的是目录而非文件
    - 跨平台支持（macOS和Windows）
    - 选择结果自动填充到存储目录配置中

#### 5.2.10 任务管理模块
- **功能**：管理下载任务队列，处理任务状态更新
- **技术实现**：
  - 使用Redis实现任务队列
  - 使用APScheduler调度任务
  - 处理任务的暂停、恢复和取消
  - 记录任务历史
  - **任务状态管理**：
    - pending：等待中
    - downloading：下载中
    - transcoding：转码中
    - completed：已完成
    - failed：下载失败
    - cancelled：已取消
  - **任务过滤**：过滤不存在的任务（task_id为None）

## 6. 部署和集成方案

### 6.1 部署环境

- **操作系统**：Linux (Ubuntu 20.04+) 或 Windows Server
- **硬件要求**：
  - CPU: 至少2核
  - 内存: 至少4GB
  - 存储空间: 根据视频存储需求，建议至少500GB
- **网络要求**：
  - 稳定的家庭网络
  - 固定的内网IP地址
  - 足够的带宽用于视频下载

### 6.2 部署步骤

1. **安装依赖**：
   - 安装Python 3.9+
   - 安装pip包管理器
   - 安装FFmpeg
   - 安装Redis

2. **配置环境**：
   - 创建虚拟环境
   - 安装项目依赖（pip install -r requirements.txt）
   - 配置Redis（可选）
   - 配置存储路径

3. **配置应用**：
   - 修改config.py中的配置项
   - 设置存储路径和其他参数

4. **启动服务**：
   - 使用gunicorn或uWSGI部署Flask应用
   - 配置系统服务，实现开机自启

5. **访问应用**：
   - 在浏览器中输入内网IP地址和端口访问应用

### 6.3 集成方案

- **前端集成**：
  - 将前端文件部署到后端静态文件目录
  - 使用Webview加载前端页面

- **服务集成**：
  - 配置Nginx作为反向代理（可选）
  - 配置防火墙规则，只允许内网访问

## 7. 代码安全性

### 7.1 前端安全

- **输入验证**：
  - 验证用户输入的URL格式
  - 防止XSS攻击

- **请求安全**：
  - 使用HTTPS（如果需要）
  - 防止CSRF攻击

### 7.2 后端安全

- **API安全**：
  - 实现请求频率限制
  - 验证请求参数

- **网络安全**：
  - 使用HTTPS（如果需要）
  - 配置防火墙，只允许内网访问

- **存储安全**：
  - 加密存储敏感信息
  - 限制文件系统权限

- **反爬安全**：
  - 实现合理的请求间隔
  - 避免过度请求导致IP被封禁

### 7.3 数据安全

- **数据库安全**：
  - 使用参数化查询，防止SQL注入
  - 限制数据库用户权限

- **用户数据安全**：
  - 加密存储用户密码
  - 保护用户隐私信息

## 8. 技术实现重点和难点

### 8.1 重点

- **视频解析**：针对不同平台实现稳定的视频解析逻辑
- **反爬策略**：实现有效的反爬措施，避免被视频平台封禁
- **下载管理**：实现可靠的下载管理，支持断点续传和进度监控
- **目录管理**：实现合理的目录结构和命名规则
- **任务日志系统**：提供完整的任务执行日志记录和查看功能

### 8.2 难点

- **平台API变化**：视频平台API可能会频繁变化，需要及时适配
- **反爬机制**：视频平台的反爬机制日益严格，需要不断更新反爬策略
- **大文件下载**：处理大文件下载时的内存和网络资源管理
- **内网部署**：确保内网服务的稳定性和可访问性
- **转码进度监控**：使用固定时长导致进度不准确，需要使用实际视频时长
- **下载超时**：大视频下载超时设置过短，需要延长到10分钟
- **进程通信死锁**：`process.communicate()`和`process.wait()`不能同时使用，需要使用独立线程监控

### 8.3 已解决的技术问题

#### 8.3.1 转码进度不准确问题
- **问题**：使用固定3600秒（1小时）作为总时长，导致进度显示不准确
- **原因**：不同视频时长差异很大，固定时长无法准确计算进度
- **解决方案**：
  - 添加`_get_video_duration()`方法获取实际视频时长
  - 使用FFmpeg解析视频信息，提取Duration字段
  - 转换为总秒数：`hours * 3600 + minutes * 60 + seconds`
  - 使用实际时长计算进度：`progress = int((time_current / time_total) * 100)`

#### 8.3.2 转码卡住问题
- **问题**：转码过程中进度不更新，用户无法看到转码进度
- **原因**：
  - `process.stderr.readline()`会阻塞等待输入
  - `process.communicate()`会等待进程结束
  - 两者同时使用导致死锁
- **解决方案**：
  - 使用独立线程监控FFmpeg输出
  - 主线程使用`process.wait()`等待进程完成
  - 监控线程读取stderr并解析进度
  - 添加30分钟超时保护

#### 8.3.3 下载超时问题
- **问题**：大视频下载超时设置为30秒，导致下载失败
- **原因**：大视频（24分钟）需要更长的下载时间
- **解决方案**：
  - 将所有下载超时从30秒延长到600秒（10分钟）
  - 修改位置：
    - `video_downloader.py:376` - 抖音下载
    - `video_downloader.py:556` - 抖音视频下载
    - `video_downloader.py:668` - B站音频下载
    - `video_downloader.py:680` - B站视频下载
    - `video_downloader.py:727` - 头条视频下载

#### 8.3.4 任务日志系统缺失
- **问题**：无法查看任务执行过程中的详细日志，难以诊断问题
- **解决方案**：
  - 在RedisManager中添加日志存储方法
  - 添加`add_task_log(task_id, message)`方法
  - 添加`get_task_logs(task_id)`方法
  - 添加`clear_task_logs(task_id)`方法
  - 限制日志条数为100条，自动清理旧日志
  - 在VideoDownloader和VideoTranscoder中添加`_log()`方法
  - 在app.py中添加`GET /api/tasks/<task_id>/logs`API端点
  - 在前端添加"日志"按钮和日志查看功能

#### 8.3.5 UI交互问题
- **问题**：转码中的任务没有进度条和取消按钮，取消后状态不更新
- **解决方案**：
  - 为所有任务状态添加"日志"按钮
  - 转码中任务显示黄色进度条
  - 转码中任务显示"取消"按钮
  - 添加"cancelled"状态徽章
  - 修改按钮逻辑：`failed`和`cancelled`状态都显示"重试"和"删除"按钮

## 9. 总结

本技术实现方案基于Python Flask和Webview技术栈，实现了泡泡看视频，支持抖音、今日头条、Bilibili三个站点的视频下载。方案包含了完整的前端和后端设计，实现了视频下载、解析、管理等核心功能，并考虑了反爬策略和安全性。

通过本方案的实施，可以构建一个稳定、高效的泡泡看视频系统，满足用户的需求。同时，方案具有良好的可扩展性，可以在未来根据需要添加新的功能和支持新的视频平台。

**已实现的关键功能**：
- ✅ 任务日志系统：完整的任务执行日志记录和查看
- ✅ 转码进度准确：使用实际视频时长计算进度
- ✅ 转码超时保护：30分钟超时自动终止
- ✅ 下载超时优化：大视频下载支持10分钟超时
- ✅ 任务取消功能：支持取消下载中和转码中的任务
- ✅ UI交互优化：转码中任务显示进度条和取消按钮
- ✅ 单元测试：提供完整的测试脚本和测试数据库隔离

**技术亮点**：
- 使用独立线程监控FFmpeg输出，避免进程通信死锁
- 使用实际视频时长计算转码进度，避免进度不准确
- 延长下载超时时间，支持大视频下载
- 提供完整的任务日志系统，便于问题诊断
- 实现测试和生产数据库隔离，确保测试不影响生产环境
